<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IremboCare+ - Your Health Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .step {
            display: none;
            animation: fadeIn 0.6s ease-in-out;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 2.8em;
            font-weight: 700;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 600;
        }
        
        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
            line-height: 1.5;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0;
            box-shadow: none;
        }
        
        .auth-tab.active {
            background: #667eea;
            color: #fff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
            text-align: left;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
            text-align: left;
        }
        
        .user-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: left;
        }
        
        .hospital-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .hospital-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .telemedicine-badge {
            background: #4CAF50;
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            display: inline-block;
        }
        
        .symptom-btn {
            background: #e3f2fd;
            color: #1976d2;
            border: 2px solid #bbdefb;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        
        .symptom-btn:hover {
            background: #1976d2;
            color: #fff;
            transform: translateY(-1px);
        }
        
        .rating-stars {
            font-size: 35px;
            margin: 20px 0;
            cursor: pointer;
        }
        
        .star {
            color: #ddd;
            margin: 0 5px;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        
        .star:hover,
        .star.active {
            color: #ffd700;
        }
        
        .tip-card {
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            text-align: left;
        }
        
        .analysis-card {
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
        }
        
        .severity-high {
            background: #ffebee;
            border: 2px solid #ffcdd2;
        }
        
        .severity-medium {
            background: #fff3e0;
            border: 2px solid #ffcc02;
        }
        
        .severity-low {
            background: #e8f5e8;
            border: 2px solid #c8e6c9;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .emergency-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            animation: pulse 2s infinite;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .emergency-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .emergency-content {
            background: #fff;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .emergency-option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .emergency-option:hover {
            border-color: #ff4757;
            background: #fff5f5;
        }
        
        .emergency-call-btn {
            background: #ff4757;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            h2 {
                font-size: 1.6em;
            }
            
            .emergency-btn {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Emergency Button -->
    <button class="emergency-btn" onclick="showEmergencyModal()">üö® EMERGENCY</button>
    
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 10%"></div>
        </div>
        
        <!-- Step 0: Authentication -->
        <div class="step active" id="step0">
            <h1>üè• IremboCare+</h1>
            <p class="subtitle">Your Complete Health Assistant for Rwanda</p>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
            </div>
            
            <div class="auth-form" id="loginForm">
                <h2>Welcome Back</h2>
                <div id="loginMessage"></div>
                <form onsubmit="handleLogin(event)">
                    <input type="email" id="loginEmail" placeholder="Email Address" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="submit">Login to Continue</button>
                </form>
                <button onclick="continueAsGuest()" style="background:#6c757d">Continue as Guest</button>
            </div>
            
            <div class="auth-form" id="registerForm" style="display:none">
                <h2>Create Your Account</h2>
                <div id="registerMessage"></div>
                <form onsubmit="handleRegister(event)">
                    <input type="text" id="regFirstName" placeholder="First Name" required>
                    <input type="text" id="regLastName" placeholder="Last Name" required>
                    <input type="email" id="regEmail" placeholder="Email Address" required>
                    <input type="password" id="regPassword" placeholder="Create Password (min 6 characters)" required>
                    <input type="date" id="regDOB" placeholder="Date of Birth">
                    <select id="regGender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="tel" id="regPhone" placeholder="Phone Number">
                    <select id="regDistrict">
                        <option value="">Select Your District</option>
                        <option value="Bugesera">Bugesera</option>
                        <option value="Burera">Burera</option>
                        <option value="Gakenke">Gakenke</option>
                        <option value="Gasabo">Gasabo</option>
                        <option value="Gatsibo">Gatsibo</option>
                        <option value="Gicumbi">Gicumbi</option>
                        <option value="Gisagara">Gisagara</option>
                        <option value="Huye">Huye</option>
                        <option value="Kamonyi">Kamonyi</option>
                        <option value="Karongi">Karongi</option>
                        <option value="Kayonza">Kayonza</option>
                        <option value="Kicukiro">Kicukiro</option>
                        <option value="Kirehe">Kirehe</option>
                        <option value="Muhanga">Muhanga</option>
                        <option value="Musanze">Musanze</option>
                        <option value="Ngoma">Ngoma</option>
                        <option value="Ngororero">Ngororero</option>
                        <option value="Nyabihu">Nyabihu</option>
                        <option value="Nyagatare">Nyagatare</option>
                        <option value="Nyamagabe">Nyamagabe</option>
                        <option value="Nyamasheke">Nyamasheke</option>
                        <option value="Nyanza">Nyanza</option>
                        <option value="Nyarugenge">Nyarugenge</option>
                        <option value="Nyaruguru">Nyaruguru</option>
                        <option value="Rubavu">Rubavu</option>
                        <option value="Ruhango">Ruhango</option>
                        <option value="Rulindo">Rulindo</option>
                        <option value="Rusizi">Rusizi</option>
                        <option value="Rutsiro">Rutsiro</option>
                        <option value="Rwamagana">Rwamagana</option>
                    </select>
                    <button type="submit">Create Account</button>
                </form>
            </div>
        </div>

        <!-- Step 1: Welcome -->
        <div class="step" id="step1">
            <div id="userWelcome" style="display:none">
                <h1>Welcome back, <span id="welcomeUserName"></span>! üëã</h1>
                <div class="user-info">
                    <h3>Your Profile</h3>
                    <p><strong>üìß Email:</strong> <span id="userEmail"></span></p>
                    <p><strong>üìç District:</strong> <span id="userDistrict"></span></p>
                    <p><strong>üìÖ Member since:</strong> <span id="memberSince"></span></p>
                </div>
                <button onclick="showDashboard()" style="background:#28a745">üìä My Health Dashboard</button>
                <button onclick="proceedToHealthServices()">üè• Find Health Services</button>
                <button onclick="logout()" style="background:#6c757d">üö™ Logout</button>
            </div>
            
            <div id="guestWelcome">
                <h1>üè• Welcome to IremboCare+</h1>
                <p class="subtitle">Your trusted health assistant for Rwanda. Get personalized health guidance, find nearby hospitals, and access emergency services.</p>
                <input type="text" id="nameInput" placeholder="Enter your name to get started" maxlength="50">
                <button onclick="proceedToHealthServices()">üöÄ Get Started</button>
            </div>
        </div>

        <!-- Step 2: District Selection (for guests) -->
        <div class="step" id="step2">
            <h2>üìç Select Your District</h2>
            <p class="subtitle">Choose your district to find nearby healthcare services</p>
            <select id="districtSelect" onchange="loadHospitals()">
                <option value="">Select Your District</option>
                <option value="Bugesera">Bugesera</option>
                <option value="Burera">Burera</option>
                <option value="Gakenke">Gakenke</option>
                <option value="Gasabo">Gasabo</option>
                <option value="Gatsibo">Gatsibo</option>
                <option value="Gicumbi">Gicumbi</option>
                <option value="Gisagara">Gisagara</option>
                <option value="Huye">Huye</option>
                <option value="Kamonyi">Kamonyi</option>
                <option value="Karongi">Karongi</option>
                <option value="Kayonza">Kayonza</option>
                <option value="Kicukiro">Kicukiro</option>
                <option value="Kirehe">Kirehe</option>
                <option value="Muhanga">Muhanga</option>
                <option value="Musanze">Musanze</option>
                <option value="Ngoma">Ngoma</option>
                <option value="Ngororero">Ngororero</option>
                <option value="Nyabihu">Nyabihu</option>
                <option value="Nyagatare">Nyagatare</option>
                <option value="Nyamagabe">Nyamagabe</option>
                <option value="Nyamasheke">Nyamasheke</option>
                <option value="Nyanza">Nyanza</option>
                <option value="Nyarugenge">Nyarugenge</option>
                <option value="Nyaruguru">Nyaruguru</option>
                <option value="Rubavu">Rubavu</option>
                <option value="Ruhango">Ruhango</option>
                <option value="Rulindo">Rulindo</option>
                <option value="Rusizi">Rusizi</option>
                <option value="Rutsiro">Rutsiro</option>
                <option value="Rwamagana">Rwamagana</option>
            </select>
            <div id="hospitalList"></div>
            <button onclick="nextStep(3)" id="continueBtn" style="display:none">Continue to Health Services</button>
        </div>

        <!-- Step 3: Health Services -->
        <div class="step" id="step3">
            <h2>üè• Healthcare Facilities</h2>
            <p class="subtitle">Healthcare services available in your area</p>
            <div id="healthServices"></div>
            <button onclick="nextStep(4)">Continue to Symptoms</button>
        </div>

        <!-- Step 4: Symptoms Entry -->
        <div class="step" id="step4">
            <h2>ü©∫ Describe Your Symptoms</h2>
            <p class="subtitle">Tell us how you're feeling so we can provide better guidance</p>
            <textarea id="symptomsInput" placeholder="Describe your symptoms in detail (e.g., headache, fever, cough, stomach pain, difficulty breathing...)" rows="6" style="resize:vertical"></textarea>
            
            <div style="margin:25px 0">
                <h3>Common Symptoms (Click to add):</h3>
                <div style="display:flex;flex-wrap:wrap;gap:10px;margin:20px 0;justify-content:center">
                    <button class="symptom-btn" onclick="addSymptom('Headache')">ü§ï Headache</button>
                    <button class="symptom-btn" onclick="addSymptom('Fever')">üå°Ô∏è Fever</button>
                    <button class="symptom-btn" onclick="addSymptom('Cough')">üò∑ Cough</button>
                    <button class="symptom-btn" onclick="addSymptom('Stomach Pain')">ü§¢ Stomach Pain</button>
                    <button class="symptom-btn" onclick="addSymptom('Nausea')">ü§Æ Nausea</button>
                    <button class="symptom-btn" onclick="addSymptom('Dizziness')">üòµ Dizziness</button>
                    <button class="symptom-btn" onclick="addSymptom('Sore Throat')">üò£ Sore Throat</button>
                    <button class="symptom-btn" onclick="addSymptom('Fatigue')">üò¥ Fatigue</button>
                </div>
            </div>
            <button onclick="predictDisease()" id="predictBtn">üîç Analyze My Symptoms</button>
        </div>

        <!-- Step 5: Disease Prediction -->
        <div class="step" id="step5">
            <h2>üîç Health Analysis Results</h2>
            <div id="predictionResult"></div>
            <button onclick="nextStep(6)">View Recommended Health Center</button>
        </div>

        <!-- Step 6: Suggested Health Center -->
        <div class="step" id="step6">
            <h2>üè• Recommended Health Center</h2>
            <p class="subtitle">Based on your symptoms and location</p>
            <div id="suggestedCenter"></div>
            <button onclick="nextStep(7)">Get Health Tips</button>
        </div>

        <!-- Step 7: Health Tips -->
        <div class="step" id="step7">
            <h2>üí° Personalized Health Tips</h2>
            <div id="healthTips"></div>
            <button onclick="nextStep(8)">Provide Feedback</button>
        </div>

        <!-- Step 8: Feedback -->
        <div class="step" id="step8">
            <h2>‚≠ê Your Feedback</h2>
            <p class="subtitle">Help us improve IremboCare+ for everyone in Rwanda</p>
            
            <div style="margin:25px 0">
                <h3>Rate your experience:</h3>
                <div class="rating-stars" id="ratingStars">
                    <span class="star" onclick="setRating(1)">‚≠ê</span>
                    <span class="star" onclick="setRating(2)">‚≠ê</span>
                    <span class="star" onclick="setRating(3)">‚≠ê</span>
                    <span class="star" onclick="setRating(4)">‚≠ê</span>
                    <span class="star" onclick="setRating(5)">‚≠ê</span>
                </div>
            </div>
            
            <textarea id="feedbackText" placeholder="Share your thoughts about IremboCare+ and how we can improve (optional)" rows="4"></textarea>
            <button onclick="submitFeedback()">Submit Feedback</button>
            <button onclick="restartApp()" style="background:#6c757d;margin-top:10px">Start Over</button>
        </div>

        <!-- Step 9: Thank You -->
        <div class="step" id="step9">
            <h2>üôè Thank You!</h2>
            <div class="success-message">
                <h3>‚úÖ Your feedback has been submitted!</h3>
                <p>Thank you for using IremboCare+. We hope we've helped you with your health concerns and provided valuable guidance.</p>
            </div>
            
            <div style="background:#f8f9fa;padding:25px;border-radius:15px;margin:25px 0;text-align:left">
                <h3>üéØ What's Next?</h3>
                <ul style="margin:15px 0;padding-left:25px;line-height:1.8">
                    <li>üìû Contact the recommended health center if needed</li>
                    <li>üíä Follow the personalized health tips provided</li>
                    <li>üö® Seek immediate medical attention for serious symptoms</li>
                    <li>üì± Use IremboCare+ again anytime you need health guidance</li>
                    <li>üë• Share IremboCare+ with family and friends</li>
                </ul>
            </div>
            
            <button onclick="restartApp()">üîÑ Use IremboCare+ Again</button>
            <button onclick="logout()" style="background:#6c757d">üö™ Logout</button>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentStep = 0;
        let selectedDistrict = '';
        let userRating = 0;
        
        // Storage Keys
        const USERS_KEY = 'iremboCare_users';
        const CURRENT_USER_KEY = 'iremboCare_currentUser';
        const FEEDBACK_KEY = 'iremboCare_feedback';

        // Initialize Application
        window.onload = function() {
            console.log('üè• IremboCare+ Application Started');
            updateProgressBar(10);
            
            // Check for existing user session
            const savedUser = localStorage.getItem(CURRENT_USER_KEY);
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showUserWelcome();
                    console.log('‚úÖ User auto-logged in:', currentUser.email);
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem(CURRENT_USER_KEY);
                }
            }
        };

        // Progress Bar
        function updateProgressBar(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // Authentication Functions
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            
            if (tab === 'login') {
                document.querySelector('.auth-tab').classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            console.log('üìù Registration attempt started');
            
            const formData = {
                firstName: document.getElementById('regFirstName').value.trim(),
                lastName: document.getElementById('regLastName').value.trim(),
                email: document.getElementById('regEmail').value.trim().toLowerCase(),
                password: document.getElementById('regPassword').value,
                dateOfBirth: document.getElementById('regDOB').value,
                gender: document.getElementById('regGender').value,
                phone: document.getElementById('regPhone').value.trim(),
                district: document.getElementById('regDistrict').value
            };

            document.getElementById('registerMessage').innerHTML = '';

            // Validation
            if (!formData.firstName || !formData.lastName || !formData.email || !formData.password) {
                showMessage('registerMessage', 'Please fill in all required fields: First Name, Last Name, Email, and Password', 'error');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                showMessage('registerMessage', 'Please enter a valid email address', 'error');
                return;
            }

            if (formData.password.length < 6) {
                showMessage('registerMessage', 'Password must be at least 6 characters long', 'error');
                return;
            }

            // Check existing users
            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            if (users.find(user => user.email === formData.email)) {
                showMessage('registerMessage', 'An account with this email already exists. Please login instead.', 'error');
                return;
            }

            // Create new user
            const newUser = {
                ...formData,
                id: Date.now(),
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem(USERS_KEY, JSON.stringify(users));

            console.log('‚úÖ User registered successfully:', formData.email);
            showMessage('registerMessage', `Registration successful! Welcome ${formData.firstName}! You can now login.`, 'success');

            setTimeout(() => {
                showAuthTab('login');
                document.getElementById('loginEmail').value = formData.email;
                showMessage('loginMessage', 'Account created successfully! Please login with your credentials.', 'success');
            }, 2000);
        }

        function handleLogin(event) {
            event.preventDefault();
            console.log('üîê Login attempt started');
            
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            document.getElementById('loginMessage').innerHTML = '';

            if (!email || !password) {
                showMessage('loginMessage', 'Please enter both email and password', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const user = users.find(u => u.email === email && u.password === password);

            if (!user) {
                console.log('‚ùå Login failed for:', email);
                showMessage('loginMessage', 'Invalid email or password. Please check your credentials.', 'error');
                return;
            }

            currentUser = user;
            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));

            console.log('‚úÖ Login successful:', email);
            showMessage('loginMessage', `Welcome back, ${user.firstName}!`, 'success');

            setTimeout(() => {
                showUserWelcome();
                nextStep(1);
                updateProgressBar(20);
            }, 1500);
        }

        function continueAsGuest() {
            console.log('üë§ Continuing as guest');
            currentUser = null;
            localStorage.removeItem(CURRENT_USER_KEY);
            nextStep(1);
            updateProgressBar(15);
        }

        function showUserWelcome() {
            if (currentUser) {
                document.getElementById('userWelcome').style.display = 'block';
                document.getElementById('guestWelcome').style.display = 'none';
                document.getElementById('welcomeUserName').textContent = currentUser.firstName;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userDistrict').textContent = currentUser.district || 'Not specified';
                document.getElementById('memberSince').textContent = new Date(currentUser.createdAt).toLocaleDateString();
            } else {
                document.getElementById('userWelcome').style.display = 'none';
                document.getElementById('guestWelcome').style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem(CURRENT_USER_KEY);
            console.log('üö™ User logged out');
            restartApp();
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function nextStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            
            // Update progress bar
            const progressPercentages = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
            updateProgressBar(progressPercentages[step] || 10);
        }

        function showDashboard() {
            alert('Health Dashboard feature coming soon! This will show your medical history, 
            pointments, and health records.');
        }

        function loadHospitals() {
            const district = document.getElementById('districtSelect').value;
            if (!district) return;
            
            selectedDistrict = district;
            const hospitals = getHospitalsByDistrict(district);
            
            let html = `<h3>üè• Hospitals in ${district}</h3>`;
            hospitals.forEach(hospital => {
                html += `
                    <div class="hospital-card">
                        <h4>${hospital.name}</h4>
                        <p><strong>üìç Location:</strong> ${hospital.location}</p>
                        <p><strong>üìû Phone:</strong> ${hospital.phone}</p>
                        <p><strong>ü©∫ Services:</strong> ${hospital.services}</p>
                        ${hospital.telemedicine ? '<span class="telemedicine-badge">Telemedicine Available</span>' : ''}
                    </div>
                `;
            });
            
            document.getElementById('hospitalList').innerHTML = html;
            document.getElementById('continueBtn').style.display = 'block';
        }

        function loadHealthServicesForUser() {
            if (currentUser && currentUser.district) {
                selectedDistrict = currentUser.district;
                const hospitals = getHospitalsByDistrict(currentUser.district);
                
                let html = `<h3>üè• Healthcare Services in ${currentUser.district}</h3>`;
                hospitals.forEach(hospital => {
                    html += `
                        <div class="hospital-card">
                            <h4>${hospital.name}</h4>
                            <p><strong>üìç Location:</strong> ${hospital.location}</p>
                            <p><strong>üìû Phone:</strong> ${hospital.phone}</p>
                            <p><strong>ü©∫ Services:</strong> ${hospital.services}</p>
                            ${hospital.telemedicine ? '<span class="telemedicine-badge">Telemedicine Available</span>' : ''}
                        </div>
                    `;
                });
                
                document.getElementById('healthServices').innerHTML = html;
            }
        }

        function proceedToHealthServices() {
            const userName = document.getElementById('nameInput').value.trim();
            if (!currentUser && userName) {
                console.log('üë§ Guest user name:', userName);
            }
            
            if (currentUser && currentUser.district) {
                // User has district, skip district selection
                loadHealthServicesForUser();
                nextStep(3);
            } else {
                // Guest or user without district, go to district selection
                nextStep(2);
            }
        }

        // Hospital Data for All Rwanda Districts
        function getHospitalsByDistrict(district) {
            const hospitalData = {
                'Gasabo': [
                    {name: 'King Faisal Hospital', location: 'Kigali', phone: '+250788123001', services: 'General Medicine, Surgery, Emergency', telemedicine: true},
                    {name: 'Kigali University Teaching Hospital (CHUK)', location: 'Nyarugenge', phone: '+250788123002', services: 'Teaching Hospital, Specialized Care', telemedicine: true},
                    {name: 'Rwanda Military Hospital', location: 'Kanombe', phone: '+250788123003', services: 'Military & Civilian Care', telemedicine: false}
                ],
                'Kicukiro': [
                    {name: 'Kigali Hospital', location: 'Nyarugunga', phone: '+250788123004', services: 'General Medicine, Maternity', telemedicine: true},
                    {name: 'Masaka Hospital', location: 'Masaka', phone: '+250788123005', services: 'General Care, Emergency', telemedicine: false}
                ],
                'Nyarugenge': [
                    {name: 'Centre Hospitalier Universitaire de Kigali (CHUK)', location: 'Mageragere', phone: '+250788123006', services: 'University Hospital, Research', telemedicine: true},
                    {name: 'Polyclinique du Plateau', location: 'Plateau', phone: '+250788123007', services: 'Private Healthcare, Specialists', telemedicine: true}
                ],
                'Huye': [
                    {name: 'University Central Hospital of Kigali (CHUK) - Huye Campus', location: 'Huye', phone: '+250788123008', services: 'Teaching Hospital', telemedicine: true},
                    {name: 'Kabutare Hospital', location: 'Kabutare', phone: '+250788123009', services: 'District Hospital, General Care', telemedicine: false}
                ],
                'Musanze': [
                    {name: 'Ruhengeri Hospital', location: 'Ruhengeri', phone: '+250788123010', services: 'District Hospital, Emergency', telemedicine: true},
                    {name: 'Shyira Hospital', location: 'Shyira', phone: '+250788123011', services: 'Mission Hospital, Surgery', telemedicine: false}
                ]
            };
            
            return hospitalData[district] || [
                {name: `${district} District Hospital`, location: district, phone: '+250788123000', services: 'General Medicine, Emergency Care', telemedicine: false},
                {name: `${district} Health Center`, location: district, phone: '+250788123001', services: 'Primary Healthcare, Vaccination', telemedicine: false}
            ];
        }

        // Symptoms and Health Analysis Functions
        function addSymptom(symptom) {
            const textarea = document.getElementById('symptomsInput');
            const currentText = textarea.value.trim();
            
            if (currentText === '') {
                textarea.value = symptom;
            } else if (!currentText.toLowerCase().includes(symptom.toLowerCase())) {
                textarea.value = currentText + ', ' + symptom;
            }
            
            textarea.focus();
        }

        function predictDisease() {
            const symptoms = document.getElementById('symptomsInput').value.trim();
            
            if (!symptoms) {
                alert('Please describe your symptoms first.');
                return;
            }
            
            console.log('üîç Analyzing symptoms:', symptoms);
            
            const analysis = analyzeSymptoms(symptoms);
            
            let severityClass = 'severity-low';
            let severityText = 'Low Priority';
            let severityIcon = 'üü¢';
            
            if (analysis.severity === 'high') {
                severityClass = 'severity-high';
                severityText = 'High Priority - Seek Immediate Care';
                severityIcon = 'üî¥';
            } else if (analysis.severity === 'medium') {
                severityClass = 'severity-medium';
                severityText = 'Medium Priority - Schedule Appointment';
                severityIcon = 'üü°';
            }
            
            const resultHtml = `
                <div class="analysis-card ${severityClass}">
                    <h3>${severityIcon} Health Analysis</h3>
                    <p><strong>Severity Level:</strong> ${severityText}</p>
                    <p><strong>Possible Condition:</strong> ${analysis.condition}</p>
                    <p><strong>Confidence:</strong> ${analysis.confidence}%</p>
                    <div style="margin-top:15px">
                        <p><strong>Analysis:</strong> ${analysis.description}</p>
                    </div>
                    <div style="margin-top:15px">
                        <p><strong>Recommendation:</strong> ${analysis.recommendation}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('predictionResult').innerHTML = resultHtml;
            nextStep(5);
        }

        function analyzeSymptoms(symptoms) {
            const symptomText = symptoms.toLowerCase();
            
            // High severity symptoms
            if (symptomText.includes('chest pain') || symptomText.includes('difficulty breathing') || 
                symptomText.includes('severe headache') || symptomText.includes('unconscious') ||
                symptomText.includes('severe bleeding') || symptomText.includes('heart attack')) {
                return {
                    severity: 'high',
                    condition: 'Emergency Medical Condition',
                    confidence: 95,
                    description: 'Your symptoms indicate a potentially serious medical emergency that requires immediate attention.',
                    recommendation: 'Seek emergency medical care immediately. Call 912 or go to the nearest emergency room.'
                };
            }
            
            // Medium severity symptoms
            if (symptomText.includes('fever') || symptomText.includes('persistent cough') ||
                symptomText.includes('stomach pain') || symptomText.includes('vomiting') ||
                symptomText.includes('diarrhea') || symptomText.includes('headache')) {
                return {
                    severity: 'medium',
                    condition: 'Common Illness',
                    confidence: 80,
                    description: 'Your symptoms suggest a common illness that should be evaluated by a healthcare professional.',
                    recommendation: 'Schedule an appointment with a healthcare provider within the next few days.'
                };
            }
            
            // Low severity symptoms
            return {
                severity: 'low',
                condition: 'Minor Health Concern',
                confidence: 70,
                description: 'Your symptoms appear to be minor and may resolve with proper self-care.',
                recommendation: 'Monitor your symptoms and consider seeing a healthcare provider if they worsen or persist.'
            };
        }

        function showSuggestedCenter() {
            if (!selectedDistrict) {
                selectedDistrict = currentUser?.district || 'Gasabo';
            }
            
            const hospitals = getHospitalsByDistrict(selectedDistrict);
            const recommendedHospital = hospitals[0];
            
            const centerHtml = `
                <div class="hospital-card" style="border: 3px solid #4CAF50; background: #f8fff8">
                    <h4>üéØ ${recommendedHospital.name}</h4>
                    <p><strong>üìç Location:</strong> ${recommendedHospital.location}</p>
                    <p><strong>üìû Phone:</strong> ${recommendedHospital.phone}</p>
                    <p><strong>ü©∫ Services:</strong> ${recommendedHospital.services}</p>
                    ${recommendedHospital.telemedicine ? '<span class="telemedicine-badge">Telemedicine Available</span>' : ''}
                    <div style="margin-top:15px; padding:15px; background:#e8f5e8; border-radius:8px">
                        <p><strong>üí° Why this center?</strong> Based on your symptoms and location in ${selectedDistrict}, this facility offers the most appropriate care for your condition.</p>
                    </div>
                </div>
            `;
            
            document.getElementById('suggestedCenter').innerHTML = centerHtml;
        }

        function showHealthTips() {
            const tips = [
                {
                    icon: 'üíß',
                    title: 'Stay Hydrated',
                    description: 'Drink plenty of clean water throughout the day. Aim for 8-10 glasses daily to support your immune system and overall health.'
                },
                {
                    icon: 'üçé',
                    title: 'Eat Nutritious Foods',
                    description: 'Include fresh fruits, vegetables, and whole grains in your diet. Local foods like sweet potatoes, beans, and leafy greens are excellent choices.'
                },
                {
                    icon: 'üò¥',
                    title: 'Get Adequate Rest',
                    description: 'Aim for 7-9 hours of quality sleep each night. Rest is crucial for recovery and maintaining a strong immune system.'
                },
                {
                    icon: 'üßº',
                    title: 'Practice Good Hygiene',
                    description: 'Wash your hands frequently with soap and clean water, especially before eating and after using the bathroom.'
                },
                {
                    icon: 'üèÉ',
                    title: 'Stay Active',
                    description: 'Engage in regular physical activity like walking, dancing, or traditional Rwandan exercises to maintain good health.'
                }
            ];
            
            let tipsHtml = '<div style="text-align:left">';
            tips.forEach(tip => {
                tipsHtml += `
                    <div class="tip-card">
                        <h4>${tip.icon} ${tip.title}</h4>
                        <p>${tip.description}</p>
                    </div>
                `;
            });
            tipsHtml += '</div>';
            
            document.getElementById('healthTips').innerHTML = tipsHtml;
        }

        // Rating and Feedback Functions
        function setRating(rating) {
            userRating = rating;
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function submitFeedback() {
            const feedbackText = document.getElementById('feedbackText').value.trim();
            
            if (userRating === 0) {
                alert('Please rate your experience before submitting feedback.');
                return;
            }
            
            const feedback = {
                rating: userRating,
                comment: feedbackText,
                user: currentUser?.email || 'Guest',
                timestamp: new Date().toISOString(),
                district: selectedDistrict
            };
            
            // Save feedback to localStorage
            const existingFeedback = JSON.parse(localStorage.getItem(FEEDBACK_KEY) || '[]');
            existingFeedback.push(feedback);
            localStorage.setItem(FEEDBACK_KEY, JSON.stringify(existingFeedback));
            
            console.log('üìù Feedback submitted:', feedback);
            nextStep(9);
        }

        function restartApp() {
            currentStep = 0;
            selectedDistrict = '';
            userRating = 0;
            
            // Clear form inputs
            document.getElementById('symptomsInput').value = '';
            document.getElementById('feedbackText').value = '';
            if (document.getElementById('nameInput')) {
                document.getElementById('nameInput').value = '';
            }
            
            // Reset rating stars
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            
            // Go back to authentication or welcome step
            if (currentUser) {
                showUserWelcome();
                nextStep(1);
            } else {
                nextStep(0);
            }
            
            updateProgressBar(10);
        }

        // Override nextStep function to handle auto-triggers
        const originalNextStep = nextStep;
        function nextStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            
            // Update progress bar
            const progressPercentages = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
            updateProgressBar(progressPercentages[step] || 10);
            
            // Auto-trigger certain functions based on step
            if (step === 6) {
                setTimeout(showSuggestedCenter, 100);
            } else if (step === 7) {
                setTimeout(showHealthTips, 100);
            }
        }

        // Emergency Functions
        function showEmergencyModal() {
            const modal = document.createElement('div');
            modal.className = 'emergency-modal';
            modal.onclick = (e) => {
                if (e.target === modal) closeEmergencyModal();
            };
            
            modal.innerHTML = `
                <div class="emergency-content">
                    <h2 style="color: #ff4757; margin-bottom: 20px;">üö® Emergency Services</h2>
                    
                    <div class="emergency-option" onclick="callEmergency()">
                        <h3>üìû Direct Emergency Call (912)</h3>
                        <p>Call Rwanda Emergency Services immediately</p>
                        <button class="emergency-call-btn">Call 912 Now</button>
                    </div>
                    
                    <div class="emergency-option" onclick="showNearestEmergencyRooms()">
                        <h3>üè• Nearest Emergency Rooms</h3>
                        <p>Find closest 24/7 emergency facilities</p>
                    </div>
                    
                    <div class="emergency-option" onclick="showCriticalSymptomsChecker()">
                        <h3>‚ö†Ô∏è Critical Symptoms Checker</h3>
                        <p>Assess if you need immediate medical attention</p>
                    </div>
                    
                    <div class="emergency-option" onclick="showEmergencyContacts()">
                        <h3>üìû Emergency Contacts</h3>
                        <p>Complete list of Rwanda emergency numbers</p>
                    </div>
                    
                    <button onclick="closeEmergencyModal()" style="background: #6c757d; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; cursor: pointer;">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeEmergencyModal() {
            const modal = document.querySelector('.emergency-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function callEmergency() {
            if (confirm('This will call Rwanda Emergency Services (912). Continue?')) {
                window.open('tel:912');
            }
        }
        
        function showNearestEmergencyRooms() {
            const emergencyHospitals = [
                {
                    name: 'King Faisal Hospital',
                    location: 'Kigali, Gasabo',
                    phone: '+250788123001',
                    distance: '2.5 km',
                    status: '24/7 Emergency'
                },
                {
                    name: 'Centre Hospitalier Universitaire de Kigali (CHUK)',
                    location: 'Kigali, Nyarugenge',
                    phone: '+250788123002',
                    distance: '3.1 km',
                    status: '24/7 Emergency'
                },
                {
                    name: 'Rwanda Military Hospital',
                    location: 'Kanombe, Kicukiro',
                    phone: '+250788123003',
                    distance: '4.2 km',
                    status: '24/7 Emergency'
                }
            ];
            
            let html = '<h3>üè• Nearest Emergency Facilities</h3>';
            emergencyHospitals.forEach(hospital => {
                html += `
                    <div class="hospital-card" style="border-left: 4px solid #ff4757;">
                        <h4>${hospital.name}</h4>
                        <p><strong>üìç Location:</strong> ${hospital.location}</p>
                        <p><strong>üìè Distance:</strong> ${hospital.distance}</p>
                        <p><strong>‚úÖ Status:</strong> ${hospital.status}</p>
                        <button class="emergency-call-btn" onclick="window.open('tel:${hospital.phone}')">Call Now</button>
                    </div>
                `;
            });
            
            const modal = document.querySelector('.emergency-content');
            modal.innerHTML = html + '<button onclick="closeEmergencyModal()" style="background: #6c757d; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; cursor: pointer;">Close</button>';
        }
        
        function showCriticalSymptomsChecker() {
            const modal = document.querySelector('.emergency-content');
            modal.innerHTML = `
                <h3>‚ö†Ô∏è Critical Symptoms Assessment</h3>
                <p style="margin-bottom: 20px;">Check if you have any of these critical symptoms that require immediate emergency care:</p>
                
                <div style="background: #ffebee; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ff4757;">
                    <h4>üî¥ Call 912 Immediately if you have:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                        <li>Severe chest pain or pressure</li>
                        <li>Difficulty breathing or shortness of breath</li>
                        <li>Severe bleeding that won't stop</li>
                        <li>Loss of consciousness or fainting</li>
                        <li>Severe head injury</li>
                        <li>Signs of stroke (face drooping, arm weakness, speech difficulty)</li>
                        <li>Severe allergic reaction</li>
                        <li>Poisoning or overdose</li>
                    </ul>
                    <button class="emergency-call-btn" onclick="callEmergency()">Call 912 Now</button>
                </div>
                
                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffcc02;">
                    <h4>üü° Seek Medical Attention Soon for:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                        <li>High fever (over 39¬∞C/102¬∞F)</li>
                        <li>Persistent vomiting or diarrhea</li>
                        <li>Severe abdominal pain</li>
                        <li>Signs of infection</li>
                        <li>Persistent headache</li>
                    </ul>
                </div>
                
                <button onclick="closeEmergencyModal()" style="background: #6c757d; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; cursor: pointer;">Close</button>
            `;
        }
        
        function showEmergencyContacts() {
            const modal = document.querySelector('.emergency-content');
            modal.innerHTML = `
                <h3>üìû Rwanda Emergency Contacts</h3>
                
                <div style="display: grid; gap: 15px; margin: 20px 0;">
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>Emergency Services</h4>
                            <p>General emergency response</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:912')">912</button>
                    </div>
                    
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>Police</h4>
                            <p>Law enforcement emergency</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:113')">113</button>
                    </div>
                    
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>Fire Department</h4>
                            <p>Fire and rescue services</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:112')">112</button>
                    </div>
                    
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>King Faisal Hospital</h4>
                            <p>24/7 Emergency Department</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:+250788123001')">Call</button>
                    </div>
                    
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>CHUK Emergency</h4>
                            <p>University Hospital Emergency</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:+250788123002')">Call</button>
                    </div>
                    
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>Mental Health Crisis</h4>
                            <p>Mental health emergency support</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:+250788123005')">Call</button>
                    </div>
                    
                    <div class="emergency-option" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>Ambulance Service</h4>
                            <p>Emergency medical transport</p>
                        </div>
                        <button class="emergency-call-btn" onclick="window.open('tel:912')">912</button>
                    </div>
                </div>
                
                <button onclick="closeEmergencyModal()" style="background: #6c757d; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; cursor: pointer;">Close</button>
            `;
        }
    </script>
</body>
</html>
